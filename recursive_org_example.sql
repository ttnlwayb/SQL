CREATE TABLE ORG (
ORGID VARCHAR(10),
PARENTID VARCHAR(10),
NAME NVARCHAR(30)
);

DELETE ORG
INSERT INTO ORG VALUES('ORG000', 'ORG000', N'公司')
INSERT INTO ORG VALUES('ORG100', 'ORG000', N'研發處')
INSERT INTO ORG VALUES('ORG110', 'ORG100', N'研發一部')
INSERT INTO ORG VALUES('ORG120', 'ORG100', N'研發二部')
INSERT INTO ORG VALUES('ORG130', 'ORG100', N'研發三部')
INSERT INTO ORG VALUES('ORG200', 'ORG000', N'業務處')
INSERT INTO ORG VALUES('ORG210', 'ORG200', N'業務一部')
INSERT INTO ORG VALUES('ORG220', 'ORG200', N'業務二部')
INSERT INTO ORG VALUES('ORG230', 'ORG200', N'業務三部')
INSERT INTO ORG VALUES('ORG300', 'ORG000', N'生產處')
INSERT INTO ORG VALUES('ORG310', 'ORG300', N'生產一部')
INSERT INTO ORG VALUES('ORG320', 'ORG300', N'生產二部')
INSERT INTO ORG VALUES('ORG330', 'ORG300', N'生產三部')
SELECT * FROM ORG

CREATE TABLE ROLE (
ROLID VARCHAR(10),
PARENTID VARCHAR(10),
NAME NVARCHAR(30)
);

DELETE ROLE
INSERT INTO ROLE VALUES('ROL000', 'ORG000', N'總經理')
INSERT INTO ROLE VALUES('ROL100', 'ORG100', N'研發處長')
INSERT INTO ROLE VALUES('ROL110', 'ORG110', N'研發一部長')
INSERT INTO ROLE VALUES('ROL120', 'ORG120', N'研發二部長')
INSERT INTO ROLE VALUES('ROL130', 'ORG130', N'研發三部長')
INSERT INTO ROLE VALUES('ROL200', 'ORG200', N'業務處長')
INSERT INTO ROLE VALUES('ROL210', 'ORG210', N'業務一部長')
INSERT INTO ROLE VALUES('ROL220', 'ORG220', N'業務二部長')
INSERT INTO ROLE VALUES('ROL230', 'ORG230', N'業務三部長')
INSERT INTO ROLE VALUES('ROL300', 'ORG300', N'生產處長')
INSERT INTO ROLE VALUES('ROL310', 'ORG310', N'生產一部長')
INSERT INTO ROLE VALUES('ROL320', 'ORG320', N'生產二部長')
INSERT INTO ROLE VALUES('ROL330', 'ORG330', N'生產三部長')
SELECT * FROM ROLE


CREATE TABLE EMPLOYEE (
EMPID VARCHAR(10),
PARENTID VARCHAR(10),
NAME NVARCHAR(30)
);
DELETE EMPLOYEE
INSERT INTO EMPLOYEE VALUES('EMP000', 'ROL000', N'甲員')
INSERT INTO EMPLOYEE VALUES('EMP100', 'ROL100', N'乙員')
INSERT INTO EMPLOYEE VALUES('EMP110', 'ROL110', N'丙員')
INSERT INTO EMPLOYEE VALUES('EMP120', 'ROL120', N'丁員')
INSERT INTO EMPLOYEE VALUES('EMP130', 'ROL130', N'戊員')
INSERT INTO EMPLOYEE VALUES('EMP200', 'ROL200', N'己員')
INSERT INTO EMPLOYEE VALUES('EMP210', 'ROL210', N'庚員')
INSERT INTO EMPLOYEE VALUES('EMP220', 'ROL220', N'辛員')
INSERT INTO EMPLOYEE VALUES('EMP230', 'ROL230', N'壬員')
INSERT INTO EMPLOYEE VALUES('EMP300', 'ROL300', N'癸員')
INSERT INTO EMPLOYEE VALUES('EMP310', 'ROL310', N'子員')
INSERT INTO EMPLOYEE VALUES('EMP320', 'ROL320', N'丑員')
INSERT INTO EMPLOYEE VALUES('EMP330', 'ROL330', N'寅員')
SELECT * FROM EMPLOYEE



WITH ALLDATA AS (
	SELECT ORGID ID, PARENTID, NAME FROM ORG
  	UNION ALL
	SELECT ROLID ID, PARENTID, NAME FROM ROLE
  	UNION ALL
	SELECT EMPID ID, PARENTID, NAME  FROM EMPLOYEE
),
 DLOOP (ID, NAME, PARENTID, PATH, LEVEL) AS 
(
    SELECT ID, NAME, PARENTID, CAST(NAME as nvarchar(1000)) as PATH, 1 FROM ALLDATA
    UNION ALL
    SELECT B.ID, 
           B.NAME,
           B.PARENTID, 
  		   CAST(PATH + '/' + B.NAME as nvarchar(1000)) as PATH,
  		   LEVEL + 1
    FROM ALLDATA B
    INNER JOIN DLOOP AS A ON B.ParentID = A.ID
    AND B.ID <> 'ORG000'
), ORG_PATH AS (
SELECT A.* FROM DLOOP A
INNER JOIN
(SELECT ID, MAX(LEVEL) LEVEL FROM DLOOP
GROUP BY ID
) B
ON A.ID = B.ID AND A.LEVEL = B.LEVEL

), EMP_PATH AS (
SELECT * FROM ORG_PATH
where ID LIKE 'EMP%'
)
SELECT * FROM EMP_PATH